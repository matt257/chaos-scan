generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Scan {
  id                   String   @id @default(cuid())
  createdAt            DateTime @default(now()) @map("createdAt")
  status               String   @default("pending")
  warnings             Json     @default("[]")
  extractionConfidence String?  @map("extractionConfidence")
  executiveSummary     String?  @map("executiveSummary") @db.Text

  uploads Upload[]
  facts   Fact[]
  issues  Issue[]

  @@map("Scan")
}

model Upload {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now()) @map("createdAt")
  scanId     String   @map("scanId")
  filename   String?
  mimeType   String?  @map("mimeType")
  sourceType String   @map("sourceType")
  rawText    String   @map("rawText") @db.Text

  scan Scan @relation(fields: [scanId], references: [id], onDelete: Cascade)

  @@map("Upload")
}

model Fact {
  id              String  @id @default(cuid())
  scanId          String  @map("scanId")
  factId          String  @map("factId")
  factType        String  @map("factType")
  entityName      String? @map("entityName")
  amountValue     Float?  @map("amountValue")
  amountCurrency  String? @map("amountCurrency")
  dateValue       String? @map("dateValue")
  dateType        String? @map("dateType")
  status          String
  recurrence      String
  sourceType      String  @map("sourceType")
  sourceReference String  @map("sourceReference")
  confidence      Float
  notes           String?
  // Bank transaction specific fields
  direction       String  @default("unknown") @map("direction")       // inflow, outflow, unknown
  clearingStatus  String  @default("unknown") @map("clearingStatus")  // cleared, pending, reversed, unknown
  rawAmountText   String? @map("rawAmountText")                       // Original amount text before normalization

  scan          Scan            @relation(fields: [scanId], references: [id], onDelete: Cascade)
  issueEvidence IssueEvidence[]

  @@index([scanId])
  @@map("Fact")
}

model Issue {
  id            String   @id @default(cuid())
  scanId        String   @map("scanId")
  createdAt     DateTime @default(now()) @map("createdAt")
  issueType     String   @map("issueType")
  title         String
  severity      String   // high, medium, low
  confidence    Float
  impactMin     Float?   @map("impactMin")
  impactMax     Float?   @map("impactMax")
  currency      String?
  rationaleJson Json     @map("rationaleJson") // Array of rationale bullet points
  entityName    String?  @map("entityName")

  scan     Scan            @relation(fields: [scanId], references: [id], onDelete: Cascade)
  evidence IssueEvidence[]

  @@index([scanId])
  @@map("Issue")
}

model IssueEvidence {
  id      String @id @default(cuid())
  issueId String @map("issueId")
  factId  String @map("factId")

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  fact  Fact  @relation(fields: [factId], references: [id], onDelete: Cascade)

  @@unique([issueId, factId])
  @@map("IssueEvidence")
}
